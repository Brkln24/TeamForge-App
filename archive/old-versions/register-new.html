<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - TeamForge</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        .register-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            padding: 2rem;
        }

        .register-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            max-width: 600px;
            width: 100%;
            border: 1px solid var(--border-primary);
        }

        .register-header {
            padding: 2rem 2rem 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-primary);
        }

        .header-brand {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .register-body {
            padding: 2rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--border-primary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin: 0 0.5rem;
            position: relative;
        }

        .step.active {
            background: var(--primary-color);
            color: white;
        }

        .step.completed {
            background: var(--success-color);
            color: white;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 40px;
            height: 2px;
            background: var(--border-primary);
            transform: translateY(-50%);
        }

        .step:last-child::after {
            display: none;
        }

        .step.completed::after {
            background: var(--success-color);
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .role-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .role-card {
            border: 2px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-primary);
        }

        .role-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .role-card.selected {
            border-color: var(--primary-color);
            background: rgba(49, 130, 206, 0.1);
        }

        .role-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .role-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .role-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .btn-primary, .btn-secondary {
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            margin: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(49, 130, 206, 0.3);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border-primary);
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            border-left: 4px solid #dc2626;
        }

        .success-message {
            background: #dcfce7;
            color: #16a34a;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            border-left: 4px solid #16a34a;
        }

        .login-link {
            text-align: center;
            margin-top: 1.5rem;
        }

        .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        .key-validation {
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .key-validation.valid {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #16a34a;
        }

        .key-validation.invalid {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        @media (max-width: 768px) {
            .role-selection {
                grid-template-columns: 1fr;
            }

            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }

            .register-container {
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="register-page">
        <div class="register-container">
            <div class="register-header">
                <h1 class="header-brand">TeamForge</h1>
                <p class="header-subtitle">Join the basketball community</p>
            </div>

            <div class="register-body">
                <div class="step-indicator">
                    <div class="step active" id="step1">1</div>
                    <div class="step" id="step2">2</div>
                    <div class="step" id="step3">3</div>
                </div>

                <div id="messageContainer"></div>

                <form id="registrationForm">
                    <!-- Step 1: Basic Information -->
                    <div class="form-step active" id="step1-content">
                        <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Basic Information</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" id="firstName" name="firstName" class="form-input" placeholder="John" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" id="lastName" name="lastName" class="form-input" placeholder="Doe" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" id="email" name="email" class="form-input" placeholder="john@example.com" required>
                        </div>

                        <div class="form-group">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" id="phone" name="phone" class="form-input" placeholder="+1 (555) 123-4567" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" id="password" name="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword" class="form-label">Confirm Password</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Role Selection -->
                    <div class="form-step" id="step2-content">
                        <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Choose Your Role</h3>
                        
                        <div class="role-selection">
                            <div class="role-card" data-role="coach">
                                <div class="role-icon">üë®‚Äçüè´</div>
                                <div class="role-title">Create Team</div>
                                <div class="role-description">Start as a coach and create your own team</div>
                            </div>
                            <div class="role-card" data-role="player">
                                <div class="role-icon">üèÄ</div>
                                <div class="role-title">Join Team</div>
                                <div class="role-description">Join an existing team as a player</div>
                            </div>
                        </div>

                        <!-- Registration Key Input (for players) -->
                        <div id="registrationKeySection" style="display: none;">
                            <div class="form-group">
                                <label for="registrationKey" class="form-label">Registration Key</label>
                                <input type="text" id="registrationKey" name="registrationKey" class="form-input" placeholder="Enter 8-character key" style="text-transform: uppercase;" maxlength="8">
                                <small style="color: var(--text-secondary); font-size: 0.85rem;">Get this key from your coach or team manager</small>
                            </div>
                            <div id="keyValidation"></div>
                        </div>
                    </div>

                    <!-- Step 3: Additional Details -->
                    <div class="form-step" id="step3-content">
                        <!-- Coach Details -->
                        <div id="coachDetails" style="display: none;">
                            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Team Information</h3>
                            
                            <div class="form-group">
                                <label for="teamName" class="form-label">Team Name</label>
                                <input type="text" id="teamName" name="teamName" class="form-input" placeholder="Eagles Basketball Team" required>
                            </div>

                            <div class="form-group">
                                <label for="league" class="form-label">League</label>
                                <input type="text" id="league" name="league" class="form-input" placeholder="Metro Basketball League" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="homeVenue" class="form-label">Home Venue</label>
                                    <input type="text" id="homeVenue" name="homeVenue" class="form-input" placeholder="Main Court">
                                </div>
                                <div class="form-group">
                                    <label for="trainingVenue" class="form-label">Training Venue</label>
                                    <input type="text" id="trainingVenue" name="trainingVenue" class="form-input" placeholder="Practice Gym">
                                </div>
                            </div>
                        </div>

                        <!-- Player Details -->
                        <div id="playerDetails" style="display: none;">
                            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Player Information</h3>
                            
                            <div class="form-row-3">
                                <div class="form-group">
                                    <label for="height" class="form-label">Height (cm)</label>
                                    <input type="number" id="height" name="height" class="form-input" placeholder="180">
                                </div>
                                <div class="form-group">
                                    <label for="weight" class="form-label">Weight (kg)</label>
                                    <input type="number" id="weight" name="weight" class="form-input" placeholder="75">
                                </div>
                                <div class="form-group">
                                    <label for="age" class="form-label">Age</label>
                                    <input type="number" id="age" name="age" class="form-input" placeholder="22">
                                </div>
                            </div>

                            <div class="form-row-3">
                                <div class="form-group">
                                    <label for="wingspan" class="form-label">Wingspan (cm)</label>
                                    <input type="number" id="wingspan" name="wingspan" class="form-input" placeholder="185">
                                </div>
                                <div class="form-group">
                                    <label for="vertical" class="form-label">Vertical Jump (cm)</label>
                                    <input type="number" id="vertical" name="vertical" class="form-input" placeholder="65">
                                </div>
                                <div class="form-group">
                                    <label for="jerseyNumber" class="form-label">Jersey Number</label>
                                    <input type="number" id="jerseyNumber" name="jerseyNumber" class="form-input" placeholder="23">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="position" class="form-label">Position</label>
                                <select id="position" name="position" class="form-select">
                                    <option value="">Select Position</option>
                                    <option value="Point Guard">Point Guard</option>
                                    <option value="Shooting Guard">Shooting Guard</option>
                                    <option value="Small Forward">Small Forward</option>
                                    <option value="Power Forward">Power Forward</option>
                                    <option value="Center">Center</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" id="prevBtn" class="btn-secondary" style="display: none;">Previous</button>
                        <div style="flex: 1;"></div>
                        <button type="button" id="nextBtn" class="btn-primary">Next</button>
                        <button type="submit" id="submitBtn" class="btn-primary" style="display: none;">Register</button>
                    </div>
                </form>

                <div class="login-link">
                    <p>Already have an account? <a href="login.html">Login here</a></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class RegistrationWizard {
            constructor() {
                this.currentStep = 1;
                this.selectedRole = null;
                this.validRegistrationKey = null;
                this.maxSteps = 3;
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // Navigation buttons
                document.getElementById('nextBtn').addEventListener('click', () => this.nextStep());
                document.getElementById('prevBtn').addEventListener('click', () => this.prevStep());
                document.getElementById('registrationForm').addEventListener('submit', (e) => this.handleSubmit(e));

                // Role selection
                document.querySelectorAll('.role-card').forEach(card => {
                    card.addEventListener('click', () => this.selectRole(card.dataset.role));
                });

                // Registration key validation
                document.getElementById('registrationKey').addEventListener('input', (e) => {
                    this.validateRegistrationKey(e.target.value);
                });

                // Password confirmation
                document.getElementById('confirmPassword').addEventListener('input', () => {
                    this.validatePasswords();
                });
            }

            selectRole(role) {
                this.selectedRole = role;
                
                // Update UI
                document.querySelectorAll('.role-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-role="${role}"]`).classList.add('selected');

                // Show/hide registration key section
                const keySection = document.getElementById('registrationKeySection');
                if (role === 'player') {
                    keySection.style.display = 'block';
                } else {
                    keySection.style.display = 'none';
                    this.validRegistrationKey = null;
                }
            }

            async validateRegistrationKey(key) {
                const validationDiv = document.getElementById('keyValidation');
                
                if (!key || key.length !== 8) {
                    validationDiv.innerHTML = '';
                    this.validRegistrationKey = null;
                    return;
                }

                try {
                    const result = window.db.validateRegistrationKey(key.toUpperCase());
                    
                    if (result.valid) {
                        validationDiv.innerHTML = `
                            <div class="key-validation valid">
                                ‚úì Valid key for team: ${result.team_name} (${result.role})
                            </div>
                        `;
                        this.validRegistrationKey = result;
                    } else {
                        validationDiv.innerHTML = `
                            <div class="key-validation invalid">
                                ‚úó ${result.message}
                            </div>
                        `;
                        this.validRegistrationKey = null;
                    }
                } catch (error) {
                    console.error('Key validation error:', error);
                    validationDiv.innerHTML = `
                        <div class="key-validation invalid">
                            ‚úó Error validating key
                        </div>
                    `;
                    this.validRegistrationKey = null;
                }
            }

            validatePasswords() {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (confirmPassword && password !== confirmPassword) {
                    document.getElementById('confirmPassword').style.borderColor = '#dc2626';
                    return false;
                } else {
                    document.getElementById('confirmPassword').style.borderColor = '';
                    return true;
                }
            }

            validateStep(step) {
                if (step === 1) {
                    const required = ['firstName', 'lastName', 'email', 'phone', 'password', 'confirmPassword'];
                    const valid = required.every(field => document.getElementById(field).value.trim());
                    return valid && this.validatePasswords();
                } else if (step === 2) {
                    if (!this.selectedRole) return false;
                    if (this.selectedRole === 'player' && !this.validRegistrationKey) return false;
                    return true;
                } else if (step === 3) {
                    if (this.selectedRole === 'coach') {
                        return document.getElementById('teamName').value.trim() && 
                               document.getElementById('league').value.trim();
                    }
                    return true;
                }
                return true;
            }

            nextStep() {
                if (!this.validateStep(this.currentStep)) {
                    this.showMessage('Please fill in all required fields correctly.', 'error');
                    return;
                }

                if (this.currentStep < this.maxSteps) {
                    this.currentStep++;
                    this.updateStepDisplay();
                }
            }

            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateStepDisplay();
                }
            }

            updateStepDisplay() {
                // Update step indicators
                for (let i = 1; i <= this.maxSteps; i++) {
                    const step = document.getElementById(`step${i}`);
                    if (i < this.currentStep) {
                        step.className = 'step completed';
                    } else if (i === this.currentStep) {
                        step.className = 'step active';
                    } else {
                        step.className = 'step';
                    }
                }

                // Show/hide step content
                document.querySelectorAll('.form-step').forEach(step => {
                    step.classList.remove('active');
                });
                document.getElementById(`step${this.currentStep}-content`).classList.add('active');

                // Update navigation buttons
                document.getElementById('prevBtn').style.display = this.currentStep > 1 ? 'block' : 'none';
                document.getElementById('nextBtn').style.display = this.currentStep < this.maxSteps ? 'block' : 'none';
                document.getElementById('submitBtn').style.display = this.currentStep === this.maxSteps ? 'block' : 'none';

                // Show appropriate details section on step 3
                if (this.currentStep === 3) {
                    if (this.selectedRole === 'coach') {
                        document.getElementById('coachDetails').style.display = 'block';
                        document.getElementById('playerDetails').style.display = 'none';
                    } else {
                        document.getElementById('coachDetails').style.display = 'none';
                        document.getElementById('playerDetails').style.display = 'block';
                    }
                }
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                if (!this.validateStep(this.currentStep)) {
                    this.showMessage('Please fill in all required fields correctly.', 'error');
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating Account...';

                try {
                    // Collect form data
                    const formData = new FormData(e.target);
                    const userData = Object.fromEntries(formData.entries());

                    // Create user account
                    const userResult = await window.db.register({
                        username: userData.email, // Use email as username
                        email: userData.email,
                        phone: userData.phone,
                        password: userData.password,
                        first_name: userData.firstName,
                        last_name: userData.lastName,
                        role: this.selectedRole
                    });

                    if (!userResult.success) {
                        throw new Error(userResult.message);
                    }

                    const user = userResult.user;

                    if (this.selectedRole === 'coach') {
                        // Create team
                        const team = window.db.createTeam({
                            name: userData.teamName,
                            league: userData.league,
                            home_venue: userData.homeVenue,
                            training_venue: userData.trainingVenue
                        });

                        // Add coach to team
                        window.db.addTeamMember(team.id, user.id, 'coach');

                    } else if (this.selectedRole === 'player') {
                        // Create player profile
                        window.db.createPlayerProfile(user.id, {
                            height_cm: parseInt(userData.height) || null,
                            weight_kg: parseInt(userData.weight) || null,
                            wingspan_cm: parseInt(userData.wingspan) || null,
                            vertical_cm: parseInt(userData.vertical) || null,
                            age: parseInt(userData.age) || null,
                            jersey_number: parseInt(userData.jerseyNumber) || null,
                            preferred_position: userData.position
                        });

                        // Add to team using registration key
                        window.db.addTeamMember(
                            this.validRegistrationKey.team_id, 
                            user.id, 
                            this.validRegistrationKey.role,
                            {
                                jersey_number: parseInt(userData.jerseyNumber) || null,
                                position: userData.position
                            }
                        );

                        // Mark registration key as used
                        window.db.useRegistrationKey(this.validRegistrationKey.key_id);
                    }

                    this.showMessage('Registration successful! Redirecting to login...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);

                } catch (error) {
                    console.error('Registration error:', error);
                    this.showMessage(error.message || 'Registration failed. Please try again.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Register';
                }
            }

            showMessage(message, type) {
                const container = document.getElementById('messageContainer');
                container.innerHTML = `
                    <div class="${type}-message">
                        ${message}
                    </div>
                `;
                container.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            new RegistrationWizard();
        });
    </script>

    <script src="js/database.js"></script>
</body>
</html>
