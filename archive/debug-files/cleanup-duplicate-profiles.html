<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanup Duplicate Player Profiles</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .cleanup-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .cleanup-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .duplicate-group {
            background: #fff;
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .profile-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .profile-empty {
            background-color: #ffebee;
            border-color: #f44336;
        }
        .profile-data {
            background-color: #e8f5e8;
            border-color: #4caf50;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        .btn-success {
            background-color: #4caf50;
            color: white;
        }
        .btn-warning {
            background-color: #ff9800;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .status-message {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cleanup Duplicate Player Profiles</h1>
        <p>This tool identifies and removes duplicate player profiles, keeping only the ones with biometric data.</p>
        
        <button class="btn btn-warning" onclick="analyzeProfiles()">Analyze Profiles</button>
        <button class="btn btn-success" onclick="cleanupDuplicates()">Remove Empty Duplicates</button>
        
        <div id="analysis-output"></div>
        <div id="cleanup-output"></div>
    </div>

    <script src="js/database.js"></script>
    <script>
        function analyzeProfiles() {
            try {
                const profiles = window.db.getTable('player_profiles') || [];
                const users = window.db.getTable('users') || [];
                
                // Group profiles by user_id
                const profileGroups = {};
                profiles.forEach(profile => {
                    if (!profileGroups[profile.user_id]) {
                        profileGroups[profile.user_id] = [];
                    }
                    profileGroups[profile.user_id].push(profile);
                });
                
                // Find duplicates
                const duplicates = Object.entries(profileGroups).filter(([userId, profiles]) => profiles.length > 1);
                
                let html = `
                    <div class="cleanup-section">
                        <div class="cleanup-title">Profile Analysis Results</div>
                        <p><strong>Total Profiles:</strong> ${profiles.length}</p>
                        <p><strong>Unique Users:</strong> ${Object.keys(profileGroups).length}</p>
                        <p><strong>Users with Duplicate Profiles:</strong> ${duplicates.length}</p>
                    </div>
                `;
                
                if (duplicates.length > 0) {
                    html += `<div class="cleanup-section">
                        <div class="cleanup-title">Duplicate Profiles Found</div>`;
                    
                    duplicates.forEach(([userId, userProfiles]) => {
                        const user = users.find(u => u.id === userId);
                        const userName = user ? `${user.first_name} ${user.last_name}` : 'Unknown User';
                        
                        html += `
                            <div class="duplicate-group">
                                <h4>User: ${userName} (ID: ${userId})</h4>
                                <p><strong>Number of profiles:</strong> ${userProfiles.length}</p>
                        `;
                        
                        userProfiles.forEach((profile, index) => {
                            const hasData = profile.height_cm !== null || profile.weight_kg !== null || 
                                          profile.wingspan_cm !== null || profile.vertical_cm !== null || 
                                          profile.age !== null;
                            
                            const className = hasData ? 'profile-data' : 'profile-empty';
                            const status = hasData ? '✅ HAS DATA' : '❌ EMPTY';
                            
                            html += `
                                <div class="profile-item ${className}">
                                    <strong>Profile ${index + 1}</strong> (ID: ${profile.id}) ${status}<br>
                                    Height: ${profile.height_cm || 'null'}, 
                                    Weight: ${profile.weight_kg || 'null'}, 
                                    Wingspan: ${profile.wingspan_cm || 'null'}, 
                                    Vertical: ${profile.vertical_cm || 'null'}, 
                                    Age: ${profile.age || 'null'}
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    });
                    
                    html += '</div>';
                } else {
                    html += `
                        <div class="status-success">
                            ✅ No duplicate profiles found! All users have only one profile.
                        </div>
                    `;
                }
                
                document.getElementById('analysis-output').innerHTML = html;
                
            } catch (error) {
                console.error('Error analyzing profiles:', error);
                document.getElementById('analysis-output').innerHTML = `
                    <div class="status-error">
                        Error analyzing profiles: ${error.message}
                    </div>
                `;
            }
        }
        
        function cleanupDuplicates() {
            try {
                const profiles = window.db.getTable('player_profiles') || [];
                const users = window.db.getTable('users') || [];
                
                // Group profiles by user_id
                const profileGroups = {};
                profiles.forEach(profile => {
                    if (!profileGroups[profile.user_id]) {
                        profileGroups[profile.user_id] = [];
                    }
                    profileGroups[profile.user_id].push(profile);
                });
                
                // Find duplicates and clean them up
                const duplicates = Object.entries(profileGroups).filter(([userId, profiles]) => profiles.length > 1);
                
                if (duplicates.length === 0) {
                    document.getElementById('cleanup-output').innerHTML = `
                        <div class="status-info">
                            ℹ️ No duplicate profiles found to clean up.
                        </div>
                    `;
                    return;
                }
                
                let cleaned = [];
                let kept = [];
                let newProfiles = [];
                
                duplicates.forEach(([userId, userProfiles]) => {
                    const user = users.find(u => u.id === userId);
                    const userName = user ? `${user.first_name} ${user.last_name}` : 'Unknown User';
                    
                    // Find profile with data
                    const profileWithData = userProfiles.find(p => 
                        p.height_cm !== null || p.weight_kg !== null || 
                        p.wingspan_cm !== null || p.vertical_cm !== null || p.age !== null
                    );
                    
                    if (profileWithData) {
                        // Keep the profile with data
                        kept.push({ user: userName, profile: profileWithData });
                        newProfiles.push(profileWithData);
                        
                        // Mark empty profiles for removal
                        userProfiles.forEach(profile => {
                            if (profile.id !== profileWithData.id) {
                                cleaned.push({ user: userName, profile: profile });
                            }
                        });
                    } else {
                        // All profiles are empty, keep the first one
                        kept.push({ user: userName, profile: userProfiles[0] });
                        newProfiles.push(userProfiles[0]);
                        
                        // Remove the rest
                        userProfiles.slice(1).forEach(profile => {
                            cleaned.push({ user: userName, profile: profile });
                        });
                    }
                });
                
                // Add profiles that don't have duplicates
                Object.entries(profileGroups).forEach(([userId, userProfiles]) => {
                    if (userProfiles.length === 1) {
                        newProfiles.push(userProfiles[0]);
                    }
                });
                
                // Save the cleaned profiles
                window.db.setTable('player_profiles', newProfiles);
                
                let html = `
                    <div class="cleanup-section">
                        <div class="cleanup-title">Cleanup Results</div>
                        <div class="status-success">
                            ✅ Cleanup completed successfully!
                        </div>
                        <p><strong>Profiles removed:</strong> ${cleaned.length}</p>
                        <p><strong>Profiles kept:</strong> ${kept.length}</p>
                        <p><strong>Total profiles after cleanup:</strong> ${newProfiles.length}</p>
                    </div>
                `;
                
                if (cleaned.length > 0) {
                    html += `
                        <div class="cleanup-section">
                            <div class="cleanup-title">Removed Profiles</div>
                    `;
                    
                    cleaned.forEach(item => {
                        html += `
                            <div class="profile-item profile-empty">
                                <strong>${item.user}</strong> - Profile ID: ${item.profile.id} (empty profile)
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                if (kept.length > 0) {
                    html += `
                        <div class="cleanup-section">
                            <div class="cleanup-title">Kept Profiles</div>
                    `;
                    
                    kept.forEach(item => {
                        const hasData = item.profile.height_cm !== null || item.profile.weight_kg !== null;
                        html += `
                            <div class="profile-item ${hasData ? 'profile-data' : 'profile-empty'}">
                                <strong>${item.user}</strong> - Profile ID: ${item.profile.id} 
                                ${hasData ? '(with biometric data)' : '(empty but kept as only profile)'}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                document.getElementById('cleanup-output').innerHTML = html;
                
                // Re-run analysis to show updated state
                setTimeout(() => {
                    analyzeProfiles();
                }, 1000);
                
            } catch (error) {
                console.error('Error cleaning up profiles:', error);
                document.getElementById('cleanup-output').innerHTML = `
                    <div class="status-error">
                        Error cleaning up profiles: ${error.message}
                    </div>
                `;
            }
        }
        
        // Run analysis on page load
        document.addEventListener('DOMContentLoaded', function() {
            analyzeProfiles();
        });
    </script>
</body>
</html>
