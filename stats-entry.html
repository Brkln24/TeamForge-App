<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats Entry - TeamForge</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/role-based.css">
    <style>
        /* Stats Entry Specific Styles */
        .stats-entry-container {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .stats-entry-header {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            border-radius: 8px 8px 0 0;
            text-align: center;
            margin-bottom: 0;
        }

        .game-timer {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .game-status-text {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            background: var(--bg-primary, #1a202c);
            border: 1px solid var(--border-primary);
            flex: 1;
            min-height: 500px;
        }

        .team-column {
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
        }

        .team-column:last-child {
            border-right: none;
        }

        .team-header {
            background: var(--bg-tertiary);
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .team-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .team-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .team-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .team-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .players-grid {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary, #2d3748);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .player-row:hover {
            background: var(--bg-tertiary, #4a5568);
        }

        .player-row.selected {
            background: #2b6cb0;
            border-color: #3182ce;
        }

        .player-row.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .player-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .player-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color, #3182ce);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .player-name {
            font-weight: 500;
            color: var(--text-primary, white);
            font-size: 0.9rem;
        }

        .points, .fouls {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-secondary, #a0aec0);
        }

        .points {
            color: #48bb78;
        }

        .fouls {
            color: #f56565;
        }

        .actions-bar {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            align-items: center;
        }

        .action-btn {
            padding: 0.75rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background: white;
            color: var(--primary-color);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.scoring {
            border-color: #22c55e;
            color: #22c55e;
        }

        .action-btn.scoring:hover:not(:disabled) {
            background: #22c55e;
            color: white;
        }

        .action-btn.special {
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .action-btn.special:hover:not(:disabled) {
            background: #f59e0b;
            color: white;
        }

        .action-btn.negative {
            border-color: #ef4444;
            color: #ef4444;
        }

        .action-btn.negative:hover:not(:disabled) {
            background: #ef4444;
            color: white;
        }

        /* Read-only mode styles */
        .stats-entry-container.read-only {
            opacity: 0.9;
        }

        .stats-entry-container.read-only .game-timer {
            color: #94a3b8;
        }

        .stats-entry-container.read-only .selected-name {
            color: #94a3b8 !important;
        }

        .stats-entry-container.read-only .no-selection {
            color: #64748b;
            font-style: italic;
        }

        .read-only-indicator {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 0.5rem 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 0 0 8px 8px;
            margin-bottom: 1rem;
        }

        .control-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-primary);
        }

        .control-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            border: none;
            font-size: 0.9rem;
        }

        .control-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .control-btn.primary:hover {
            background: var(--accent-secondary, #2c5aa0);
            transform: translateY(-1px);
        }

        .control-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-primary);
        }

        .control-btn.secondary:hover {
            background: var(--border-primary);
            color: var(--text-primary);
        }

        .control-btn.success {
            background: #22c55e;
            color: white;
        }

        .control-btn.success:hover {
            background: #16a34a;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .selected-player-info {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--bg-primary);
            border-radius: 6px;
        }

        .no-selection {
            color: var(--text-secondary);
        }

        .has-selection {
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Make/Miss Modal */
        .make-miss-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .make-miss-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            min-width: 300px;
            border: 2px solid var(--primary-color);
        }

        .make-miss-content h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .make-miss-content p {
            color: var(--text-primary);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .make-miss-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .make-btn, .miss-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .make-btn {
            background: #10b981;
            color: white;
        }

        .make-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .miss-btn {
            background: #ef4444;
            color: white;
        }

        .miss-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .cancel-btn {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }

        .cancel-btn:hover {
            background: var(--border-primary);
        }

        /* Game Log Modal */
        .log-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .log-modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }

        .log-modal-header {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            font-weight: 600;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-modal-body {
            padding: 1rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .close-log-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-log-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .log-entry {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--bg-primary);
            border-radius: 4px;
            border-left: 3px solid var(--accent-primary);
            font-size: 0.85rem;
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
            min-width: 60px;
        }

        .log-player {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 100px;
        }

        .log-action {
            color: var(--text-secondary);
        }

        /* Minutes Modal */
        .minutes-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .minutes-modal-content {
            background-color: var(--bg-secondary);
            margin: 20% auto;
            padding: 1.5rem;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }

        .minutes-modal-content h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
        }

        .minutes-modal-content select {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .message-display {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .message-display.success {
            background: #22c55e;
        }

        .message-display.error {
            background: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .teams-container {
                grid-template-columns: 1fr;
            }
            
            .team-column {
                border-right: none;
                border-bottom: 1px solid var(--border-primary);
            }
            
            .team-column:last-child {
                border-bottom: none;
            }
            
            .actions-bar {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 0.3rem;
            }
            
            .action-btn {
                padding: 0.5rem;
                font-size: 0.8rem;
                min-height: 40px;
            }
            
            .control-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .log-modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }

        .game-log {
            max-height: 600px;
            overflow-y: auto;
        }

        .log-entry {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--bg-primary);
            border-radius: 4px;
            border-left: 3px solid var(--accent-primary);
            font-size: 0.85rem;
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
            min-width: 60px;
        }

        .log-player {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 100px;
        }

        .log-action {
            color: var(--text-secondary);
            flex: 1;
        }

        .delete-log-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .delete-log-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .finalize-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-primary);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-secondary, #2c5aa0);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(49, 130, 206, 0.2);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--border-primary);
            color: var(--text-primary);
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-success:hover {
            background: #2f855a;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Minutes Modal */
        .minutes-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .minutes-modal-content {
            background-color: var(--bg-secondary);
            margin: 20% auto;
            padding: 1.5rem;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }

        .minutes-modal-content h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
        }

        .minutes-modal-content select {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .message-display {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .message-display.success {
            background: #38a169;
        }

        .message-display.error {
            background: #e53e3e;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .stats-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .log-section {
                height: 300px;
            }
            
            .stats-table {
                font-size: 0.7rem;
            }
            
            .stats-table th,
            .stats-table td {
                padding: 0.2rem 0.1rem;
            }
            
            .stat-btn {
                width: 24px;
                height: 20px;
                font-size: 0.6rem;
            }
            
            .player-cell {
                font-size: 0.7rem;
            }
        }
    </style>

    <!-- Modern Firebase v12+ Modular SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, connectAuthEmulator } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        // Your TeamForge Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCrAPyjI91mdpOXgrUO6vKP83TbhMfQGKI",
            authDomain: "teamforgeproject-37f27.firebaseapp.com",
            projectId: "teamforgeproject-37f27",
            storageBucket: "teamforgeproject-37f27.firebasestorage.app",
            messagingSenderId: "625240400602",
            appId: "1:625240400602:web:c24e30c9ba4f28b0bafbe3",
            measurementId: "G-V2GBMH5H88"
        };

        try {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // Make Firebase available globally for testing
            window.firebaseApp = app;
            window.firebaseDB = db;
            window.firebaseAuth = auth;
            window.firebaseConfig = firebaseConfig;
            
            console.log('üî• Firebase v12+ initialized successfully');
            console.log('üìä Project ID:', firebaseConfig.projectId);
            
            // Mark Firebase as loaded
            window.firebaseLoaded = true;
            
        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error);
            window.firebaseError = error;
        }
    </script>
</head>
<body>
    <div id="app">
        <header class="header">
            <nav class="navbar">
                <!-- Navigation will be populated by JavaScript -->
            </nav>
        </header>

        <main class="main-content">
            <div class="container">
                <div class="stats-entry-container">
                    <div class="stats-entry-header">
                        <div class="game-status-text">Pre Game</div>
                        <div class="game-timer" id="gameTimer">10:00</div>
                        <div class="game-status-text" id="gameInfo">Loading...</div>
                    </div>
                    
                    <div class="teams-container">
                        <!-- Home Team Column -->
                        <div class="team-column">
                            <div class="team-header">
                                <div class="team-info">
                                    <div class="team-icon" id="homeTeamIcon">H</div>
                                    <div class="team-name" id="homeTeamName">Home Team</div>
                                </div>
                                <div class="team-score" id="homeTeamScore">0</div>
                            </div>
                            <div class="players-grid" id="homePlayersGrid">
                                <!-- Home team players will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Away Team Column -->
                        <div class="team-column">
                            <div class="team-header">
                                <div class="team-info">
                                    <div class="team-icon" id="awayTeamIcon">A</div>
                                    <div class="team-name" id="awayTeamName">Away Team</div>
                                </div>
                                <div class="team-score" id="awayTeamScore">0</div>
                            </div>
                            <div class="players-grid" id="awayPlayersGrid">
                                <!-- Away team players will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="actions-bar">
                        <div class="selected-player-info" id="selectedPlayerInfo">
                            <span class="no-selection">Select a player to record stats</span>
                        </div>
                        
                        <!-- Scoring Actions -->
                        <button class="action-btn scoring" onclick="window.statsEntryApp.handleScoringAction('1pt')" disabled id="action1PT">1</button>
                        <button class="action-btn scoring" onclick="window.statsEntryApp.handleScoringAction('2pt')" disabled id="action2PT">2</button>
                        <button class="action-btn scoring" onclick="window.statsEntryApp.handleScoringAction('3pt')" disabled id="action3PT">3</button>
                        
                        <!-- Regular Stats -->
                        <button class="action-btn" onclick="window.statsEntryApp.addStatToSelected('rebounds')" disabled id="actionREB">REB</button>
                        <button class="action-btn" onclick="window.statsEntryApp.addStatToSelected('assists')" disabled id="actionAST">AST</button>
                        <button class="action-btn" onclick="window.statsEntryApp.addStatToSelected('steals')" disabled id="actionSTL">STL</button>
                        <button class="action-btn" onclick="window.statsEntryApp.addStatToSelected('blocks')" disabled id="actionBLK">BLK</button>
                        <button class="action-btn negative" onclick="window.statsEntryApp.addStatToSelected('turnovers')" disabled id="actionTO">TO</button>
                        <button class="action-btn negative" onclick="window.statsEntryApp.addStatToSelected('fouls')" disabled id="actionFOUL">FOUL</button>
                        
                        <!-- Special Actions -->
                        <button class="action-btn special" onclick="window.statsEntryApp.showMinutesDialog()" disabled id="actionMIN">MIN</button>
                        <button class="action-btn special" onclick="window.statsEntryApp.undoLastAction()" disabled id="actionUNDO">UNDO</button>
                        
                        <!-- Control Actions -->
                        <div class="control-actions">
                            <button class="control-btn secondary" onclick="window.statsEntryApp.showGameLog()">Game Log</button>
                            <button class="control-btn success" id="finalizeGameBtn" onclick="window.statsEntryApp.finalizeGame()">Finalize Game</button>
                            <a href="calendar.html" class="control-btn secondary">Back to Calendar</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Game Log Modal -->
    <div id="gameLogModal" class="log-modal">
        <div class="log-modal-content">
            <div class="log-modal-header">
                <span>Game Log</span>
                <button class="close-log-modal" onclick="window.statsEntryApp.closeGameLog()">&times;</button>
            </div>
            <div class="log-modal-body" id="gameLogContent">
                <!-- Game log entries will appear here -->
            </div>
        </div>
    </div>

    <!-- Minutes Modal -->
    <div id="minutesModal" class="minutes-modal">
        <div class="minutes-modal-content">
            <h3>Add Minutes</h3>
            <select id="minutesSelect">
                <option value="1">1 minute</option>
                <option value="2">2 minutes</option>
                <option value="3">3 minutes</option>
                <option value="4">4 minutes</option>
                <option value="5">5 minutes</option>
                <option value="10">10 minutes</option>
                <option value="12">12 minutes</option>
                <option value="15">15 minutes</option>
                <option value="20">20 minutes</option>
                <option value="24">24 minutes</option>
                <option value="32">32 minutes</option>
                <option value="40">40 minutes</option>
            </select>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeMinutesModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addMinutes()">Add</button>
            </div>
        </div>
    </div>

    <div class="message-display" id="messageDisplay"></div>

    <script>
        class StatsEntryApp {
            constructor() {
                this.gameId = null;
                this.game = null;
                this.homeTeam = null;
                this.awayTeam = null;
                this.homeTeamPlayers = [];
                this.awayTeamPlayers = [];
                this.gameLog = [];
                this.playerStats = {};
                this.isFinalized = false;
                this.selectedPlayer = null;
                this.currentPlayer = null;
                this.isReadOnly = false; // Add read-only mode
                this.init();
            }

            async init() {
                try {
                    // Check authentication
                    const currentUser = window.db?.getCurrentUser();
                    if (!currentUser) {
                        window.location.href = 'login.html';
                        return;
                    }

                    // Get game ID and check for read-only mode from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    this.gameId = urlParams.get('gameId');
                    this.isReadOnly = urlParams.get('readOnly') === 'true';
                    
                    if (!this.gameId) {
                        this.showMessage('No game specified', 'error');
                        setTimeout(() => window.location.href = 'calendar.html', 2000);
                        return;
                    }

                    console.log('Loading game data for gameId:', this.gameId);
                    console.log('Read-only mode:', this.isReadOnly);
                    
                    // Load game and team data
                    await this.loadGameData();
                    
                    console.log('Game loaded:', this.game);
                    console.log('Home team:', this.homeTeam);
                    console.log('Home players:', this.homeTeamPlayers);
                    console.log('Away team:', this.awayTeam);
                    console.log('Away players:', this.awayTeamPlayers);
                    
                    this.loadExistingStats();
                    this.renderGameInfo();
                    this.renderTeams();
                    this.updateGameStatus();
                    this.setupReadOnlyMode(); // Setup read-only mode if needed
                } catch (error) {
                    console.error('Error initializing stats entry:', error);
                    this.showMessage(`Error loading game data: ${error.message}`, 'error');
                }
            }

            async loadGameData() {
                // Get game details
                this.game = window.db.getEventById(this.gameId);
                if (!this.game) {
                    throw new Error('Game not found');
                }

                console.log('=== GAME DATA DEBUG ===');
                console.log('Game:', this.game);
                console.log('Game opponent_team_id:', this.game.opponent_team_id);

                // Get home team (user's team)
                this.homeTeam = window.db.getTeamById(this.game.team_id);
                if (!this.homeTeam) {
                    throw new Error('Home team not found');
                }
                
                console.log('Home team:', this.homeTeam);
                
                // Get home team players and normalize field names
                const rawHomePlayers = window.db.getTeamPlayers(this.game.team_id) || [];
                this.homeTeamPlayers = rawHomePlayers.map(player => ({
                    ...player,
                    firstName: player.firstName || player.first_name || 'Unknown',
                    lastName: player.lastName || player.last_name || 'Player',
                    jerseyNumber: player.jerseyNumber || player.jersey_number || '00'
                }));
                
                console.log('Home players raw:', rawHomePlayers);
                console.log('Home players processed:', this.homeTeamPlayers);
                
                // Get away team (opponent)
                if (this.game.opponent_team_id) {
                    console.log('Looking for opponent team with ID:', this.game.opponent_team_id);
                    this.awayTeam = window.db.getTeamById(this.game.opponent_team_id);
                    console.log('Found opponent team:', this.awayTeam);
                    
                    if (this.awayTeam) {
                        const rawAwayPlayers = window.db.getTeamPlayers(this.game.opponent_team_id) || [];
                        console.log('Away players raw:', rawAwayPlayers);
                        
                        this.awayTeamPlayers = rawAwayPlayers.map(player => ({
                            ...player,
                            firstName: player.firstName || player.first_name || 'Unknown',
                            lastName: player.lastName || player.last_name || 'Player',
                            jerseyNumber: player.jerseyNumber || player.jersey_number || '00'
                        }));
                        console.log('Away players processed:', this.awayTeamPlayers);
                    } else {
                        console.error('Opponent team not found with ID:', this.game.opponent_team_id);
                        this.awayTeam = { name: 'Opponent (Not Found)', id: 'opponent' };
                        this.awayTeamPlayers = [];
                    }
                } else {
                    console.warn('Game has no opponent_team_id set');
                    // Create dummy opponent team if none specified
                    this.awayTeam = { name: 'Opponent', id: 'opponent' };
                    this.awayTeamPlayers = [];
                }
                
                console.log('=== FINAL TEAM DATA ===');
                console.log('Away team final:', this.awayTeam);
                console.log('Away players final:', this.awayTeamPlayers);
                
                // Initialize player stats for both teams
                [...this.homeTeamPlayers, ...this.awayTeamPlayers].forEach(player => {
                    this.playerStats[player.id] = {
                        points: 0, rebounds: 0, assists: 0, steals: 0, blocks: 0, turnovers: 0,
                        fg_made: 0, fg_attempted: 0, three_made: 0, three_attempted: 0,
                        ft_made: 0, ft_attempted: 0, minutes: 0, fouls: 0
                    };
                });
            }

            setupReadOnlyMode() {
                if (this.isReadOnly) {
                    // Add read-only class to container
                    const container = document.querySelector('.stats-entry-container');
                    if (container) {
                        container.classList.add('read-only');
                    }
                    
                    // Add read-only indicator to header
                    const header = document.querySelector('.stats-entry-header');
                    if (header && !document.querySelector('.read-only-indicator')) {
                        const readOnlyIndicator = document.createElement('div');
                        readOnlyIndicator.className = 'read-only-indicator';
                        readOnlyIndicator.innerHTML = '<i class="bi bi-bar-chart-fill"></i> View Only Mode - Game Statistics';
                        header.parentNode.insertBefore(readOnlyIndicator, header.nextSibling);
                    }
                    
                    // Disable all action buttons
                    const actionButtons = document.querySelectorAll('.action-btn, .control-btn.success');
                    actionButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        if (btn.id === 'finalizeGameBtn') {
                            btn.textContent = 'View Only Mode';
                            btn.style.opacity = '0.6';
                        }
                    });

                    // Update header to show view-only status
                    const gameTimer = document.getElementById('gameTimer');
                    if (gameTimer) {
                        gameTimer.textContent = 'FINAL';
                        gameTimer.style.fontSize = '1.5rem';
                    }

                    // Update selected player info to show view-only
                    const selectedPlayerInfo = document.getElementById('selectedPlayerInfo');
                    if (selectedPlayerInfo) {
                        selectedPlayerInfo.innerHTML = '<span class="no-selection">View Only Mode - Game Statistics</span>';
                    }

                    // Remove click handlers from player rows
                    document.querySelectorAll('.player-row').forEach(row => {
                        row.style.cursor = 'default';
                        row.onclick = null;
                        // Keep hover effects but prevent selection
                        row.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                    });

                    console.log('Read-only mode enabled - all editing disabled');
                }
            }

            loadExistingStats() {
                // Check if game is finalized first
                const gameFinalized = localStorage.getItem(`teamforge_game_finalized_${this.gameId}`);
                if (gameFinalized) {
                    this.isFinalized = true;
                    this.isReadOnly = true; // Force read-only if finalized
                }

                // Load from database if game is finalized, otherwise from localStorage
                if (this.isFinalized) {
                    // Load finalized stats from database
                    const gameStats = window.db.getGameStats(this.gameId);
                    gameStats.forEach(stat => {
                        this.playerStats[stat.player_id] = {
                            points: stat.points || 0,
                            rebounds: stat.rebounds || 0,
                            assists: stat.assists || 0,
                            steals: stat.steals || 0,
                            blocks: stat.blocks || 0,
                            turnovers: stat.turnovers || 0,
                            fg_made: stat.fg_made || 0,
                            fg_attempted: stat.fg_attempted || 0,
                            three_made: stat.three_made || 0,
                            three_attempted: stat.three_attempted || 0,
                            ft_made: stat.ft_made || 0,
                            ft_attempted: stat.ft_attempted || 0,
                            minutes: stat.minutes || 0,
                            fouls: stat.fouls || 0
                        };
                    });
                } else {
                    // Load temporary stats from localStorage
                    const existingLog = localStorage.getItem(`teamforge_game_log_${this.gameId}`);
                    const existingStats = localStorage.getItem(`teamforge_game_stats_${this.gameId}`);
                    
                    if (existingLog) {
                        this.gameLog = JSON.parse(existingLog);
                    }
                    
                    if (existingStats) {
                        this.playerStats = JSON.parse(existingStats);
                    }
                }
            }

            renderGameInfo() {
                if (!this.game) return;

                const gameDate = new Date(this.game.event_date);
                const gameInfoText = `${this.game.title} - ${gameDate.toLocaleDateString()} at ${gameDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                
                const gameInfoElement = document.getElementById('gameInfo');
                if (gameInfoElement) {
                    gameInfoElement.textContent = gameInfoText;
                }
            }

            renderTeams() {
                const homeContainer = document.getElementById('homePlayersGrid');
                const awayContainer = document.getElementById('awayPlayersGrid');
                
                if (!homeContainer || !awayContainer) {
                    console.error('Team containers not found in DOM');
                    return;
                }
                
                // Update team headers
                const homeTeamName = document.getElementById('homeTeamName');
                const awayTeamName = document.getElementById('awayTeamName');
                
                if (homeTeamName) homeTeamName.textContent = this.homeTeam.name;
                if (awayTeamName) awayTeamName.textContent = this.awayTeam.name;
                
                // Render home team players
                homeContainer.innerHTML = this.homeTeamPlayers.map(player => 
                    `<div class="player-row" data-player-id="${player.id}" data-team="home">
                        <div class="player-info">
                            <div class="player-number">#${player.jerseyNumber || '00'}</div>
                            <div class="player-name">${player.firstName} ${player.lastName}</div>
                        </div>
                        <div class="player-stats">
                            <span class="points">${this.playerStats[player.id]?.points || 0}pts</span>
                            <span class="fouls">${this.playerStats[player.id]?.fouls || 0}f</span>
                        </div>
                    </div>`
                ).join('');
                
                // Render away team players
                awayContainer.innerHTML = this.awayTeamPlayers.map(player => 
                    `<div class="player-row" data-player-id="${player.id}" data-team="away">
                        <div class="player-info">
                            <div class="player-number">#${player.jerseyNumber || '00'}</div>
                            <div class="player-name">${player.firstName} ${player.lastName}</div>
                        </div>
                        <div class="player-stats">
                            <span class="points">${this.playerStats[player.id]?.points || 0}pts</span>
                            <span class="fouls">${this.playerStats[player.id]?.fouls || 0}f</span>
                        </div>
                    </div>`
                ).join('');
                
                // Add click handlers for player selection
                document.querySelectorAll('.player-row').forEach(row => {
                    row.addEventListener('click', () => this.selectPlayer(row));
                });
                
                // Update team scores
                this.updateTeamScores();
            }

            selectPlayer(playerRow) {
                if (this.isFinalized || this.isReadOnly) return;
                
                // Remove previous selection
                document.querySelectorAll('.player-row').forEach(row => row.classList.remove('selected'));
                
                // Select new player
                playerRow.classList.add('selected');
                this.selectedPlayer = {
                    id: playerRow.dataset.playerId,
                    team: playerRow.dataset.team
                };
                
                // Update selected player display
                this.updateSelectedPlayerDisplay();
                
                // Update action buttons state
                this.updateActionButtons();
            }

            updateSelectedPlayerDisplay() {
                const selectedPlayerInfo = document.getElementById('selectedPlayerInfo');
                
                if (this.isReadOnly) {
                    selectedPlayerInfo.innerHTML = '<span class="no-selection">View Only Mode - Game Statistics</span>';
                    return;
                }
                
                if (this.selectedPlayer) {
                    const allPlayers = [...this.homeTeamPlayers, ...this.awayTeamPlayers];
                    const player = allPlayers.find(p => p.id === this.selectedPlayer.id);
                    selectedPlayerInfo.innerHTML = `
                        <span class="selected-name">${player.firstName} ${player.lastName}</span>
                        <span class="selected-team">${this.selectedPlayer.team === 'home' ? this.homeTeam.name : this.awayTeam.name}</span>
                    `;
                } else {
                    selectedPlayerInfo.innerHTML = '<span class="no-selection">Select a player to record stats</span>';
                }
            }

            updateActionButtons() {
                const actionButtons = document.querySelectorAll('.action-btn');
                const hasSelection = this.selectedPlayer !== null;
                
                actionButtons.forEach(btn => {
                    if (btn.id === 'actionUNDO') {
                        // UNDO button is enabled when there are actions to undo
                        btn.disabled = this.gameLog.length === 0 || this.isFinalized || this.isReadOnly;
                    } else {
                        btn.disabled = !hasSelection || this.isFinalized || this.isReadOnly;
                    }
                });
            }

            updateTeamScores() {
                const homeScore = this.homeTeamPlayers.reduce((total, player) => 
                    total + (this.playerStats[player.id]?.points || 0), 0);
                const awayScore = this.awayTeamPlayers.reduce((total, player) => 
                    total + (this.playerStats[player.id]?.points || 0), 0);
                
                const homeScoreElement = document.getElementById('homeTeamScore');
                const awayScoreElement = document.getElementById('awayTeamScore');
                
                if (homeScoreElement) homeScoreElement.textContent = homeScore;
                if (awayScoreElement) awayScoreElement.textContent = awayScore;
            }

            handleScoringAction(shotType) {
                if (!this.selectedPlayer || this.isFinalized || this.isReadOnly) return;
                
                const playerId = this.selectedPlayer.id;
                const allPlayers = [...this.homeTeamPlayers, ...this.awayTeamPlayers];
                const player = allPlayers.find(p => p.id === playerId);
                const playerName = `${player.firstName} ${player.lastName}`;
                
                // Create custom modal for make/miss selection
                const modal = document.createElement('div');
                modal.className = 'make-miss-modal';
                modal.innerHTML = `
                    <div class="make-miss-content">
                        <h3>${playerName}</h3>
                        <p>Did they make or miss the ${shotType === '1pt' ? 'free throw' : shotType === '2pt' ? 'field goal' : '3-pointer'}?</p>
                        <div class="make-miss-buttons">
                            <button class="make-btn" onclick="window.statsEntryApp.recordShot('${shotType}', 'make', '${playerId}', '${playerName}'); this.closest('.make-miss-modal').remove();">MAKE</button>
                            <button class="miss-btn" onclick="window.statsEntryApp.recordShot('${shotType}', 'miss', '${playerId}', '${playerName}'); this.closest('.make-miss-modal').remove();">MISS</button>
                        </div>
                        <button class="cancel-btn" onclick="this.closest('.make-miss-modal').remove();">Cancel</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            recordShot(shotType, result, playerId, playerName) {
                switch(shotType) {
                    case '1pt': // Free throw
                        if (result === 'make') {
                            this.playerStats[playerId].points += 1;
                            this.playerStats[playerId].ft_made += 1;
                            this.logAction(playerName, "Made free throw (+1 PT, +1 FTM, +1 FTA)", playerId);
                        } else {
                            this.logAction(playerName, "Missed free throw (+0 PT, +0 FTM, +1 FTA)", playerId);
                        }
                        this.playerStats[playerId].ft_attempted += 1;
                        break;
                        
                    case '2pt': // 2-point field goal
                        if (result === 'make') {
                            this.playerStats[playerId].points += 2;
                            this.playerStats[playerId].fg_made += 1;
                            this.logAction(playerName, "Made field goal (+2 PTS, +1 FGM, +1 FGA)", playerId);
                        } else {
                            this.logAction(playerName, "Missed field goal (+0 PTS, +0 FGM, +1 FGA)", playerId);
                        }
                        this.playerStats[playerId].fg_attempted += 1;
                        break;
                        
                    case '3pt': // 3-pointer
                        if (result === 'make') {
                            this.playerStats[playerId].points += 3;
                            this.playerStats[playerId].three_made += 1;
                            this.playerStats[playerId].fg_made += 1;
                            this.logAction(playerName, "Made 3-pointer (+3 PTS, +1 3PM, +1 3PA, +1 FGM, +1 FGA)", playerId);
                        } else {
                            this.logAction(playerName, "Missed 3-pointer (+0 PTS, +0 3PM, +1 3PA, +0 FGM, +1 FGA)", playerId);
                        }
                        this.playerStats[playerId].three_attempted += 1;
                        this.playerStats[playerId].fg_attempted += 1;
                        break;
                }
                
                this.saveStatsToStorage();
                this.renderTeams();
            }

            addStatToSelected(statType, value = 1) {
                if (!this.selectedPlayer || this.isFinalized || this.isReadOnly) return;
                
                const playerId = this.selectedPlayer.id;
                const allPlayers = [...this.homeTeamPlayers, ...this.awayTeamPlayers];
                const player = allPlayers.find(p => p.id === playerId);
                const playerName = `${player.firstName} ${player.lastName}`;
                
                switch(statType) {
                    case '1pt': // 1 point (free throw)
                        this.playerStats[playerId].points += 1;
                        this.playerStats[playerId].ft_made += 1;
                        this.playerStats[playerId].ft_attempted += 1;
                        this.logAction(playerName, "Made free throw (+1 PT, +1 FTM, +1 FTA)", playerId);
                        break;
                        
                    case '2pt': // 2 points (field goal)
                        this.playerStats[playerId].points += 2;
                        this.playerStats[playerId].fg_made += 1;
                        this.playerStats[playerId].fg_attempted += 1;
                        this.logAction(playerName, "Made field goal (+2 PTS, +1 FGM, +1 FGA)", playerId);
                        break;
                        
                    case '3pt': // 3 points
                        this.playerStats[playerId].points += 3;
                        this.playerStats[playerId].three_made += 1;
                        this.playerStats[playerId].three_attempted += 1;
                        this.playerStats[playerId].fg_made += 1;
                        this.playerStats[playerId].fg_attempted += 1;
                        this.logAction(playerName, "Made 3-pointer (+3 PTS, +1 3PM, +1 3PA, +1 FGM, +1 FGA)", playerId);
                        break;
                        
                    case 'rebounds':
                        this.playerStats[playerId].rebounds += value;
                        this.logAction(playerName, `+${value} REB`, playerId);
                        break;
                        
                    case 'assists':
                        this.playerStats[playerId].assists += value;
                        this.logAction(playerName, `+${value} AST`, playerId);
                        break;
                        
                    case 'steals':
                        this.playerStats[playerId].steals += value;
                        this.logAction(playerName, `+${value} STL`, playerId);
                        break;
                        
                    case 'blocks':
                        this.playerStats[playerId].blocks += value;
                        this.logAction(playerName, `+${value} BLK`, playerId);
                        break;
                        
                    case 'turnovers':
                        this.playerStats[playerId].turnovers += value;
                        this.logAction(playerName, `+${value} TO`, playerId);
                        break;
                        
                    case 'fouls':
                        this.playerStats[playerId].fouls += value;
                        this.logAction(playerName, `+${value} FOUL`, playerId);
                        break;
                        
                    case 'minutes':
                        this.playerStats[playerId].minutes += value;
                        this.logAction(playerName, `+${value} MIN`, playerId);
                        break;
                }
                
                // Auto-save and refresh display
                this.saveStatsToStorage();
                this.renderTeams();
            }

            showMinutesDialog() {
                if (!this.selectedPlayer || this.isFinalized) return;
                
                const playerId = this.selectedPlayer.id;
                const allPlayers = [...this.homeTeamPlayers, ...this.awayTeamPlayers];
                const player = allPlayers.find(p => p.id === playerId);
                const playerName = `${player.firstName} ${player.lastName}`;
                
                const minutes = prompt(`Add minutes for ${playerName}:`, '5');
                if (minutes && !isNaN(minutes) && parseInt(minutes) > 0) {
                    this.addStatToSelected('minutes', parseInt(minutes));
                }
            }

            undoLastAction() {
                if (this.gameLog.length === 0 || this.isFinalized || this.isReadOnly) return;
                
                const lastAction = this.gameLog.pop();
                
                // Reverse the last action based on the action text
                const playerId = lastAction.playerId;
                
                if (lastAction.action.includes("Made free throw")) {
                    this.playerStats[playerId].points -= 1;
                    this.playerStats[playerId].ft_made -= 1;
                    this.playerStats[playerId].ft_attempted -= 1;
                } else if (lastAction.action.includes("Missed free throw")) {
                    this.playerStats[playerId].ft_attempted -= 1;
                } else if (lastAction.action.includes("Made field goal")) {
                    this.playerStats[playerId].points -= 2;
                    this.playerStats[playerId].fg_made -= 1;
                    this.playerStats[playerId].fg_attempted -= 1;
                } else if (lastAction.action.includes("Missed field goal")) {
                    this.playerStats[playerId].fg_attempted -= 1;
                } else if (lastAction.action.includes("Made 3-pointer")) {
                    this.playerStats[playerId].points -= 3;
                    this.playerStats[playerId].three_made -= 1;
                    this.playerStats[playerId].three_attempted -= 1;
                    this.playerStats[playerId].fg_made -= 1;
                    this.playerStats[playerId].fg_attempted -= 1;
                } else if (lastAction.action.includes("Missed 3-pointer")) {
                    this.playerStats[playerId].three_attempted -= 1;
                    this.playerStats[playerId].fg_attempted -= 1;
                } else if (lastAction.action.includes("REB")) {
                    const value = parseInt(lastAction.action.match(/\+(\d+)/)[1]);
                    this.playerStats[playerId].rebounds -= value;
                } else if (lastAction.action.includes("AST")) {
                    const value = parseInt(lastAction.action.match(/\+(\d+)/)[1]);
                    this.playerStats[playerId].assists -= value;
                } else if (lastAction.action.includes("STL")) {
                    const value = parseInt(lastAction.action.match(/\+(\d+)/)[1]);
                    this.playerStats[playerId].steals -= value;
                } else if (lastAction.action.includes("BLK")) {
                    const value = parseInt(lastAction.action.match(/\+(\d+)/)[1]);
                    this.playerStats[playerId].blocks -= value;
                } else if (lastAction.action.includes("TO")) {
                    const value = parseInt(lastAction.action.match(/\+(\d+)/)[1]);
                    this.playerStats[playerId].turnovers -= value;
                } else if (lastAction.action.includes("FOUL")) {
                    const value = parseInt(lastAction.action.match(/\+(\d+)/)[1]);
                    this.playerStats[playerId].fouls -= value;
                } else if (lastAction.action.includes("MIN")) {
                    const value = parseInt(lastAction.action.match(/\+(\d+)/)[1]);
                    this.playerStats[playerId].minutes -= value;
                }
                
                this.saveStatsToStorage();
                this.renderTeams();
                this.showMessage('Last action undone', 'success');
            }

            saveStatsToStorage() {
                // Don't save in read-only mode
                if (this.isReadOnly) return;
                
                // Save player stats and game log
                localStorage.setItem(`teamforge_game_stats_${this.gameId}`, JSON.stringify(this.playerStats));
                localStorage.setItem(`teamforge_game_log_${this.gameId}`, JSON.stringify(this.gameLog));
            }

            logAction(playerName, action, playerId) {
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                this.gameLog.unshift({
                    timestamp,
                    player: playerName,
                    action: action,
                    playerId: playerId,
                    time: Date.now()
                });
                
                // Keep only last 100 entries
                if (this.gameLog.length > 100) {
                    this.gameLog = this.gameLog.slice(0, 100);
                }
                
                // Auto-save log
                localStorage.setItem(`teamforge_game_log_${this.gameId}`, JSON.stringify(this.gameLog));
            }

            renderGameLog() {
                const logContainer = document.getElementById('gameLogContent');
                
                if (this.gameLog.length === 0) {
                    logContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem; font-size: 0.9rem;">No actions recorded yet</p>';
                    return;
                }
                
                logContainer.innerHTML = this.gameLog.map((entry, index) => `
                    <div class="log-entry">
                        <span class="log-time">${entry.timestamp}</span>
                        <span class="log-player">${entry.player}</span>
                        <span class="log-action">${entry.action}</span>
                        ${!this.isFinalized ? `<button class="delete-log-btn" onclick="window.statsEntryApp.deleteLogEntry(${index})" title="Delete this entry">√ó</button>` : ''}
                    </div>
                `).join('');
            }

            deleteLogEntry(index) {
                if (this.isFinalized) return;
                
                if (confirm('Delete this log entry? This will also reverse its effects on player stats.')) {
                    const entryToDelete = this.gameLog[index];
                    const playerId = entryToDelete.playerId;
                    
                    // Reverse the stats for this entry
                    if (entryToDelete.action.includes("Made free throw")) {
                        this.playerStats[playerId].points -= 1;
                        this.playerStats[playerId].ft_made -= 1;
                        this.playerStats[playerId].ft_attempted -= 1;
                    } else if (entryToDelete.action.includes("Missed free throw")) {
                        this.playerStats[playerId].ft_attempted -= 1;
                    } else if (entryToDelete.action.includes("Made field goal")) {
                        this.playerStats[playerId].points -= 2;
                        this.playerStats[playerId].fg_made -= 1;
                        this.playerStats[playerId].fg_attempted -= 1;
                    } else if (entryToDelete.action.includes("Missed field goal")) {
                        this.playerStats[playerId].fg_attempted -= 1;
                    } else if (entryToDelete.action.includes("Made 3-pointer")) {
                        this.playerStats[playerId].points -= 3;
                        this.playerStats[playerId].three_made -= 1;
                        this.playerStats[playerId].three_attempted -= 1;
                        this.playerStats[playerId].fg_made -= 1;
                        this.playerStats[playerId].fg_attempted -= 1;
                    } else if (entryToDelete.action.includes("Missed 3-pointer")) {
                        this.playerStats[playerId].three_attempted -= 1;
                        this.playerStats[playerId].fg_attempted -= 1;
                    } else if (entryToDelete.action.includes("REB")) {
                        const value = parseInt(entryToDelete.action.match(/\+(\d+)/)[1]);
                        this.playerStats[playerId].rebounds -= value;
                    } else if (entryToDelete.action.includes("AST")) {
                        const value = parseInt(entryToDelete.action.match(/\+(\d+)/)[1]);
                        this.playerStats[playerId].assists -= value;
                    } else if (entryToDelete.action.includes("STL")) {
                        const value = parseInt(entryToDelete.action.match(/\+(\d+)/)[1]);
                        this.playerStats[playerId].steals -= value;
                    } else if (entryToDelete.action.includes("BLK")) {
                        const value = parseInt(entryToDelete.action.match(/\+(\d+)/)[1]);
                        this.playerStats[playerId].blocks -= value;
                    } else if (entryToDelete.action.includes("TO")) {
                        const value = parseInt(entryToDelete.action.match(/\+(\d+)/)[1]);
                        this.playerStats[playerId].turnovers -= value;
                    } else if (entryToDelete.action.includes("FOUL")) {
                        const value = parseInt(entryToDelete.action.match(/\+(\d+)/)[1]);
                        this.playerStats[playerId].fouls -= value;
                    } else if (entryToDelete.action.includes("MIN")) {
                        const value = parseInt(entryToDelete.action.match(/\+(\d+)/)[1]);
                        this.playerStats[playerId].minutes -= value;
                    }
                    
                    // Remove the entry from the log
                    this.gameLog.splice(index, 1);
                    
                    // Update displays
                    this.saveStatsToStorage();
                    this.renderTeams();
                    this.renderGameLog();
                    this.showMessage('Log entry deleted and stats updated', 'success');
                }
            }

            showGameLog() {
                this.renderGameLog();
                document.getElementById('gameLogModal').style.display = 'block';
            }

            closeGameLog() {
                document.getElementById('gameLogModal').style.display = 'none';
            }

            saveStats() {
                // Auto-save stats to localStorage
                localStorage.setItem(`teamforge_game_stats_${this.gameId}`, JSON.stringify(this.playerStats));
            }

            finalizeGame() {
                if (this.isFinalized) return;
                
                // Convert player stats to database format
                const gameStats = [];
                let hasAnyStats = false;
                
                // Process home team players
                this.homeTeamPlayers.forEach(player => {
                    const stats = this.playerStats[player.id];
                    
                    // Check if player has any stats
                    const playerHasStats = Object.values(stats).some(value => value > 0);
                    if (playerHasStats) {
                        hasAnyStats = true;
                    }
                    
                    gameStats.push({
                        player_id: player.id,
                        game_id: this.gameId,
                        team_id: this.game.team_id, // Home team ID
                        ...stats
                    });
                });
                
                // Process away team players
                this.awayTeamPlayers.forEach(player => {
                    const stats = this.playerStats[player.id];
                    
                    // Check if player has any stats
                    const playerHasStats = Object.values(stats).some(value => value > 0);
                    if (playerHasStats) {
                        hasAnyStats = true;
                    }
                    
                    gameStats.push({
                        player_id: player.id,
                        game_id: this.gameId,
                        team_id: this.game.opponent_team_id, // Away team ID
                        ...stats
                    });
                });
                
                if (!hasAnyStats) {
                    this.showMessage('Please enter some stats before finalizing the game', 'error');
                    return;
                }
                
                try {
                    // Save to database
                    window.db.saveGameStats(this.gameId, gameStats);
                    
                    // Calculate and save team stats
                    this.saveTeamStats(gameStats);
                    
                    // Update season stats for players with stats
                    gameStats.forEach(playerStats => {
                        const playerHasStats = Object.values(playerStats).some((value, index) => {
                            // Skip non-stat fields
                            const statFields = ['points', 'rebounds', 'assists', 'steals', 'blocks', 'turnovers', 'fg_made', 'fg_attempted', 'three_made', 'three_attempted', 'ft_made', 'ft_attempted', 'minutes', 'fouls'];
                            return statFields.includes(Object.keys(playerStats)[index]) && value > 0;
                        });
                        
                        if (playerHasStats) {
                            window.db.updatePlayerSeasonStats(playerStats.player_id, playerStats);
                        }
                    });
                    
                    // Mark game as finalized
                    this.isFinalized = true;
                    localStorage.setItem(`teamforge_game_finalized_${this.gameId}`, 'true');
                    
                    // Update game event to prevent deletion
                    const updatedGame = { ...this.game, is_finalized: true };
                    window.db.updateEvent(this.gameId, updatedGame);
                    
                    this.updateGameStatus();
                    this.renderTeams();
                    
                    this.showMessage('Game finalized successfully! Stats saved to season records.', 'success');
                    
                    // Redirect to stats page after a short delay to show updated stats
                    setTimeout(() => {
                        window.location.href = 'stats.html?updated=true';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error finalizing game:', error);
                    this.showMessage('Error finalizing game', 'error');
                }
            }

            saveTeamStats(gameStats) {
                // Calculate team totals for this game
                const teamStats = {
                    id: window.db.generateId(),
                    game_id: this.gameId,
                    team_id: this.game.team_id,
                    points: 0, rebounds: 0, assists: 0, steals: 0, blocks: 0, turnovers: 0,
                    fg_made: 0, fg_attempted: 0, three_made: 0, three_attempted: 0,
                    ft_made: 0, ft_attempted: 0, minutes: 0, fouls: 0,
                    created_at: new Date().toISOString()
                };
                
                gameStats.forEach(playerStats => {
                    teamStats.points += playerStats.points || 0;
                    teamStats.rebounds += playerStats.rebounds || 0;
                    teamStats.assists += playerStats.assists || 0;
                    teamStats.steals += playerStats.steals || 0;
                    teamStats.blocks += playerStats.blocks || 0;
                    teamStats.turnovers += playerStats.turnovers || 0;
                    teamStats.fg_made += playerStats.fg_made || 0;
                    teamStats.fg_attempted += playerStats.fg_attempted || 0;
                    teamStats.three_made += playerStats.three_made || 0;
                    teamStats.three_attempted += playerStats.three_attempted || 0;
                    teamStats.ft_made += playerStats.ft_made || 0;
                    teamStats.ft_attempted += playerStats.ft_attempted || 0;
                    teamStats.minutes += playerStats.minutes || 0;
                    teamStats.fouls += playerStats.fouls || 0;
                });
                
                // Save team stats
                const allTeamStats = window.db.getTable('team_stats') || [];
                allTeamStats.push(teamStats);
                window.db.setTable('team_stats', allTeamStats);
            }

            updateGameStatus() {
                const finalizeBtn = document.getElementById('finalizeGameBtn');
                
                if (this.isFinalized) {
                    if (finalizeBtn) {
                        finalizeBtn.disabled = true;
                        finalizeBtn.textContent = 'Game Finalized';
                    }
                } else {
                    if (finalizeBtn) {
                        finalizeBtn.disabled = false;
                        finalizeBtn.textContent = 'Finalize Game';
                    }
                }
            }

            getPlayerInitials(player) {
                return `${player.first_name.charAt(0)}${player.last_name.charAt(0)}`;
            }

            showMessage(message, type) {
                const messageEl = document.getElementById('messageDisplay');
                messageEl.textContent = message;
                messageEl.className = `message-display ${type}`;
                messageEl.style.display = 'block';
                
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 3000);
            }
        }

        // Global functions for modal
        function closeMinutesModal() {
            window.statsEntryApp.closeMinutesModal();
        }

        function addMinutes() {
            window.statsEntryApp.addMinutes();
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.statsEntryApp = new StatsEntryApp();
            
            // Add finalize button event listener
            document.getElementById('finalizeGameBtn').addEventListener('click', () => {
                window.statsEntryApp.finalizeGame();
            });
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const minutesModal = document.getElementById('minutesModal');
                const gameLogModal = document.getElementById('gameLogModal');
                
                if (event.target == minutesModal) {
                    closeMinutesModal();
                }
                
                if (event.target == gameLogModal) {
                    window.statsEntryApp.closeGameLog();
                }
            }
        });
    </script>

    <script src="js/database.js"></script>
    <script src="js/modern-firebase-adapter.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/navigation.js"></script>
</body>
</html>
